name: Build and release xk42 firmware

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'boards/arm/xk42/**'
      - 'config/xk42.*'
      - 'build_xk42.yaml'
      - 'config/west.yml'
      - 'zephyr/**'
    tags:
      - 'build'
permissions:
  contents: write

jobs:
  draw:
    name: Draw xk42 Keymap
    uses: caksoylar/keymap-drawer/.github/workflows/draw-zmk.yml@main
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/tags/build'
    permissions:
      contents: read
    with:
      destination: artifact
      artifact_name: xk42-keymap
      fail_on_error: true
      keymap_patterns: 'config/xk42.keymap'
  build:
    name: Build xk42
    needs: draw
    uses: zmkfirmware/zmk/.github/workflows/build-user-config.yml@main
    with:
      build_matrix_path: build_xk42.yaml
      archive_name: xk42-firmware
  release:
    name: Release xk42
    needs: [build, draw]
    if: success() && (github.ref == 'refs/heads/main' || github.ref == 'refs/tags/build')
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: xk42-firmware
          path: ./artifacts
      - name: Download keymap artifact
        uses: actions/download-artifact@v4
        with:
          name: xk42-keymap
          path: ./keymap_artifacts
      - name: Convert keymap SVG to PNG
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends librsvg2-bin
          for f in ./keymap_artifacts/*.svg; do
            [ -f "$f" ] || continue
            png="${f%.svg}.png"
            rsvg-convert "$f" -o "$png"
            echo "Converted $f -> $png"
          done
      - name: Generate build info
        id: info
        run: |
          echo "timestamp=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
          echo "short_sha=${GITHUB_SHA:0:7}" >> $GITHUB_OUTPUT
      - name: Delete existing tag
        uses: dev-drprasad/delete-tag-and-release@v1.0
        with:
          tag_name: latest-xk42
          github_token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest-xk42
          name: xk42 Latest Firmware
          body: |
            üîÅ **xk42 Build**
            Commit: ${{ steps.info.outputs.short_sha }}
            Built: ${{ steps.info.outputs.timestamp }}
            Install: flash left/right .uf2 files.
            Keymap PNG: Download from release assets
          files: |
            ./artifacts/**/*.uf2
            ./keymap_artifacts/**/*.png
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
